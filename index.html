<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Player Pro</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0a0a;color:#fff;min-height:100vh}
.hdr{background:linear-gradient(135deg,#1a1a2e,#16213e);padding:18px 24px;box-shadow:0 2px 20px rgba(0,0,0,.5)}
.hdr-in{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.logo{font-size:24px;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.badge{background:rgba(76,175,80,.2);color:#4caf50;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}
.wrap{max-width:1200px;margin:0 auto;padding:32px 20px}
.card{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:16px;padding:32px;margin-bottom:24px;box-shadow:0 8px 32px rgba(0,0,0,.3)}
.card-title{font-size:20px;font-weight:700;margin-bottom:16px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
input[type=url]{width:100%;padding:14px 16px;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:15px;margin-bottom:16px;transition:border-color .2s}
input:focus{outline:none;border-color:#667eea}
input::placeholder{color:rgba(255,255,255,.35)}
.btn{padding:14px 36px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:transform .15s,opacity .15s}
.btn:hover:not(:disabled){transform:translateY(-2px)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.sbadge{display:inline-block;margin-top:12px;background:rgba(76,175,80,.12);color:#4caf50;border:1px solid rgba(76,175,80,.28);padding:6px 12px;border-radius:6px;font-size:11px}
.err{background:rgba(244,67,54,.14);border:1px solid rgba(244,67,54,.3);color:#f44336;padding:12px 16px;border-radius:10px;margin-top:12px;display:none;line-height:1.6}
#vSec{display:none}
#vSec.on{display:block}
.ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:8px}
.ptitle{font-size:18px;font-weight:700}
.cbtn{padding:8px 16px;background:rgba(255,59,48,.18);color:#ff3b30;border:1px solid rgba(255,59,48,.25);border-radius:8px;cursor:pointer;font-weight:600;font-size:13px}
.cbtn:hover{background:rgba(255,59,48,.3)}
.pwrap{position:relative;padding-bottom:56.25%;height:0;background:#000;border-radius:12px;overflow:hidden}
video,iframe{position:absolute;inset:0;width:100%;height:100%;border:none;background:#000}
.ov{position:absolute;inset:0;z-index:5;pointer-events:none}
.tok-bar-wrap{margin-top:8px;height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden}
.tok-bar{height:100%;background:linear-gradient(90deg,#4caf50,#8bc34a);border-radius:2px;transition:width 1s linear}
.tok-lbl{font-size:10px;color:rgba(255,255,255,.3);margin-top:4px;text-align:right}
#loadSec{display:none;text-align:center;padding:48px;color:rgba(255,255,255,.5)}
.lspin{width:44px;height:44px;border:3px solid rgba(255,255,255,.1);border-top-color:#667eea;border-radius:50%;animation:sp 1s linear infinite;margin:0 auto 14px}
@keyframes sp{to{transform:rotate(360deg)}}
*{-webkit-user-select:none;-moz-user-select:none;user-select:none}
input[type=url]{-webkit-user-select:text;-moz-user-select:text;user-select:text}
video,img,iframe{-webkit-user-drag:none;user-drag:none}
@media(max-width:600px){.card{padding:20px}.logo{font-size:20px}}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-in">
    <div class="logo">ðŸŽ¬ Video Player Pro</div>
    <div class="badge">ðŸ”’ Protected</div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="card-title">Load Secure Video</div>
    <input type="url" id="urlIn" placeholder="Paste Platform B video URLâ€¦ e.g. https://platform-b.vercel.app/video/abc123">
    <button class="btn" id="loadBtn">â–¶ Load Video</button>
    <div class="sbadge">ðŸ›¡ 45-second tokens Â· Strict referer enforcement Â· UA blocklist</div>
    <div class="err" id="errBox"></div>
  </div>

  <div id="loadSec"><div class="lspin"></div><p>Connectingâ€¦</p></div>

  <div id="vSec" class="card">
    <div class="ph">
      <div class="ptitle">Now Playing</div>
      <button class="cbtn" id="closeBtn">âœ• Close</button>
    </div>
    <div class="pwrap">
      <video id="vid" controls playsinline preload="metadata"
             controlsList="nodownload nofullscreen noremoteplayback"
             disablePictureInPicture
             oncontextmenu="return false;"></video>
      <iframe id="ifr" allowfullscreen allow="autoplay"
              style="display:none" oncontextmenu="return false;"></iframe>
      <div class="ov" oncontextmenu="return false;"></div>
    </div>
    <div class="tok-bar-wrap" id="tokWrap" style="display:none">
      <div class="tok-bar" id="tokBar" style="width:100%"></div>
    </div>
    <div class="tok-lbl" id="tokLbl"></div>
  </div>
</div>

<script>
'use strict';
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEC = '84418779257393762955868022673598';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _videoId   = null;
let _base      = null;
let _tokTimer  = null;   // setInterval for token countdown
let _refreshAt = 0;      // timestamp when we should refresh the token
let _tokEnd    = 0;      // timestamp when current token expires

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const norm = u => u.replace(/([^:])\/\/+/g, '$1/');

function showErr(msg) {
  const e = document.getElementById('errBox');
  e.textContent = 'âŒ ' + msg;
  e.style.display = 'block';
  setTimeout(() => { e.style.display = 'none'; }, 10000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOKEN COUNTDOWN BAR
// Shows time remaining on current token.
// Silently refreshes the src 15s before expiry.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTokenCountdown(ttlSeconds) {
  const vid    = document.getElementById('vid');
  const bar    = document.getElementById('tokBar');
  const lbl    = document.getElementById('tokLbl');
  const wrap   = document.getElementById('tokWrap');
  const total  = ttlSeconds * 1000;

  _tokEnd     = Date.now() + total;
  _refreshAt  = _tokEnd - 15000; // refresh 15s before expiry
  wrap.style.display = 'block';
  bar.style.width    = '100%';

  clearInterval(_tokTimer);
  _tokTimer = setInterval(async () => {
    const rem = Math.max(0, _tokEnd - Date.now());
    bar.style.width = (rem / total * 100).toFixed(1) + '%';
    lbl.textContent = rem > 0
      ? `Token: ${Math.ceil(rem / 1000)}s remaining`
      : 'Refreshing tokenâ€¦';

    // Refresh token 15s before expiry
    if (Date.now() >= _refreshAt && rem > 0) {
      _refreshAt = Infinity; // prevent double-refresh
      await refreshToken();
    }

    if (rem <= 0) clearInterval(_tokTimer);
  }, 500);
}

// Silently swap the video src to a fresh URL without stopping playback
async function refreshToken() {
  if (!_videoId || !_base) return;
  const vid = document.getElementById('vid');
  try {
    const res = await fetch(norm(_base + '/api/refresh/' + _videoId), {
      headers: { 'X-Security-String': SEC }
    });
    if (!res.ok) return;
    const data = await res.json();
    if (!data.success || !data.streamUrl) return;

    // Save position, swap src, restore position
    // The browser re-issues a Range request for the exact byte offset
    // so the video resumes instantly with no buffering
    const t       = vid.currentTime;
    const paused  = vid.paused;
    vid.src       = data.streamUrl;
    vid.load();
    vid.currentTime = t;
    if (!paused) vid.play().catch(() => {});

    // Restart countdown with new token (45s)
    startTokenCountdown(45);
  } catch (_) {
    // Silently ignore â€” video keeps playing until token expires
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOAD VIDEO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVideo() {
  const url   = document.getElementById('urlIn').value.trim();
  const btn   = document.getElementById('loadBtn');
  const load  = document.getElementById('loadSec');
  const vSec  = document.getElementById('vSec');
  const vid   = document.getElementById('vid');
  const ifr   = document.getElementById('ifr');

  document.getElementById('errBox').style.display = 'none';

  if (!url || !url.includes('/video/')) {
    showErr('Invalid URL â€” must contain /video/'); return;
  }

  vSec.classList.remove('on');
  load.style.display = 'block';
  btn.disabled = true;
  clearInterval(_tokTimer);

  try {
    const m = url.match(/\/video\/([^/?#]+)/);
    if (!m) throw new Error('Cannot extract video ID');
    _videoId = m[1];
    _base    = url.slice(0, url.indexOf('/video/'));

    const res = await fetch(norm(_base + '/api/video/' + _videoId), {
      headers: { 'X-Security-String': SEC, 'Accept': 'application/json' }
    });
    if (res.status === 403) throw new Error('Access denied â€” wrong security key');
    if (res.status === 404) throw new Error('Video not found');
    if (!res.ok)            throw new Error('Server error ' + res.status);
    const data = await res.json();
    if (!data.success) throw new Error(data.message || 'Load failed');

    load.style.display = 'none';
    vSec.classList.add('on');
    btn.disabled = false;

    if (data.type === 'embed') {
      // YouTube / Vimeo / Dailymotion
      ifr.src = norm(data.proxyUrl) + '?key=' + encodeURIComponent(SEC);
      ifr.style.display = 'block';
      vid.style.display = 'none';
      document.getElementById('tokWrap').style.display = 'none';
      document.getElementById('tokLbl').textContent   = '';

    } else {
      // Direct video â€” set src, browser handles everything natively
      // No MSE, no chunking, no mp4box â€” just a URL with a token
      // Browser sends Range requests automatically for instant seeking
      ifr.style.display = 'none';
      ifr.src = '';
      vid.style.display = 'block';
      vid.src = data.streamUrl;
      vid.load();
      startTokenCountdown(data.tokenTtl || 45);
    }

  } catch (e) {
    load.style.display = 'none';
    btn.disabled = false;
    showErr(e.message);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CLOSE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeVideo() {
  clearInterval(_tokTimer);
  _videoId = _base = null;
  const vid = document.getElementById('vid');
  const ifr = document.getElementById('ifr');
  document.getElementById('vSec').classList.remove('on');
  document.getElementById('tokWrap').style.display = 'none';
  document.getElementById('tokLbl').textContent = '';
  if (vid) { vid.pause(); vid.removeAttribute('src'); vid.load(); }
  if (ifr) { ifr.src = ''; ifr.style.display = 'none'; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('loadBtn') .addEventListener('click',    loadVideo);
document.getElementById('closeBtn').addEventListener('click',    closeVideo);
document.getElementById('urlIn')   .addEventListener('keypress', e => { if (e.key === 'Enter') loadVideo(); });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANTI-DOWNLOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('contextmenu', e => { e.preventDefault(); return false; });

document.addEventListener('keydown', e => {
  const k = (e.key || '').toLowerCase();
  if ((e.ctrlKey || e.metaKey) && ['s','u','p','i','j','c'].includes(k)) { e.preventDefault(); return false; }
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && ['i','j','c'].includes(k)) { e.preventDefault(); return false; }
  if (k === 'f12' || k === 'printscreen') { e.preventDefault(); return false; }
});

document.addEventListener('dragstart', e => { e.preventDefault(); return false; });

document.addEventListener('visibilitychange', () => {
  const v = document.getElementById('vid');
  if (v && document.hidden) v.pause();
});

// Block screen capture
if (navigator.mediaDevices) {
  try {
    Object.defineProperty(navigator.mediaDevices, 'getDisplayMedia', {
      configurable: false, writable: false,
      value: () => Promise.reject(new DOMException('Not allowed', 'NotAllowedError'))
    });
  } catch (_) {}
  try {
    const _g = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
    Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
      configurable: false, writable: false,
      value: c => (c && c.video)
        ? Promise.reject(new DOMException('Not allowed', 'NotAllowedError'))
        : _g(c)
    });
  } catch (_) {}
}

try {
  Object.defineProperty(window, 'MediaRecorder', {
    configurable: false, writable: false,
    value: function() { throw new DOMException('Disabled', 'NotSupportedError'); }
  });
} catch (_) {}

// DevTools detection
(function () {
  let open = false;
  setInterval(() => {
    const isOpen = window.outerWidth - window.innerWidth > 160
                || window.outerHeight - window.innerHeight > 160;
    const v = document.getElementById('vid');
    const f = document.getElementById('ifr');
    if (isOpen && !open) {
      open = true;
      if (v) { v.pause(); v.style.visibility = 'hidden'; }
      if (f) f.style.visibility = 'hidden';
    } else if (!isOpen && open) {
      open = false;
      if (v) v.style.visibility = 'visible';
      if (f) f.style.visibility = 'visible';
    }
  }, 800);
})();
</script>
</body>
</html>
